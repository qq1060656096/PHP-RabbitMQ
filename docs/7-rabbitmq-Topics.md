# 主题模式
> 接收消息基于(正则)匹配模式

在前面的教程中我们改进的日志系统。我们使用一个direct exchange,而不是只使用fanout exchange能力的虚拟广播,,有选择地接收日志的可能性。

虽然使用的direct exchange改进我们的系统,但它仍然有一定的局限性,它不能做路由基于多个标准。

日志系统中我们不仅要订阅日志根据严重程度,但也基于源发出的日志。你可能知道这个概念的syslog unix工具,这路线日志根据严重程度(info/warn/crit…)和设备(auth/cron/kern……)。

这将给我们一个很大的灵活性——我们可能只想要来自cron错误,但也从“kern”的所有日志。

实现在我们的日志系统我们需要了解更复杂的topic exchange。

### Topic exchange

消息发送到topic exchange不可能任意routing_key——它必须是一个单词列表,使用点"."分隔。可以是任何单词,但通常他们指定一些功能连接到消息。一些有效routing_key例子:"stock.usd.nyse", "nyse.vmw", "quick.orange.rabbit".routing key可以有尽可能多的单词,但是长度不能超过255字节。

binding_key必须在相同的形式。topic exchange背后的逻辑是类似于直接一个消息发送与特定routing_key交付的所有队列与匹配的binding_key绑定。

### binding_keys有两个重要的特殊情况:
> 1. 星号"*"完全可以代表任意一个单词.
> 2. #(hash)可以代表0个或者多个单词

请看下面一个例子:
![avatar](data:image/png;base64,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)

在这个例子中,我们将发送消息,所有描述动物.消息将发送到routing_key,由3个单词和2个点组成.第1个routing_key单词celerity(快速、敏捷),第2个color(颜色),第3个species(物种): "<celerity>.<colour>.<species>".

### 我们创建了2个队列3个绑定: 
> 1. Q1 binding_key = "*.orange.*"
> - 队列Q1绑定了(橙色)
> 2. Q2 binding_key = "*.*.rabbit" and ,
> - 队列Q2绑定了(兔子)和(懒惰)

##### 绑定可以概括
> 1. 一个消息routing_key设置为"quick.orange.rabbit",它将被放到2个队列.
> 2. 消息 "lazy.orange.elephant"也会被放到2个队列,
> 3. 另一方面消息"quick.orange.fox" 会被放到Q1队列. 
> 4. 消息"lazy.brown.fox"会被放到Q2队列
> 5. 消息"lazy.pink.rabbit"虽然匹配了2个绑定,但是2个绑定都在Q2队列,只会放一次到Q2队列
> 6. 消息"quick.brown.fox" 不匹配任何绑定会被丢弃
> 7. 如果我们打破我们的合同,发送一条消息,该消息带有一个或四个单词,如"orange"或"quick.orange.male.rabbit"? 这些消息不会匹配任何绑定会被丢弃。
> 8. 消息"lazy.orange.male.rabbit" 尽管它有四个单词,它能匹配最后一个绑定("lazy.#").它会被放到Q2队列

# Topic exchange 特点
> 1. Topic exchange 最强大,它可以像其他的exchange
> 2. 当binding_key使用"#",队列就会接受所有的消息,就行fanout exchange
> 3. 当binding_key不使用特殊字符("*"和 "#"),它就像direct exchange

# 示例(demo):
我们的日志系统使用 topic exchange.我们将开始一个工作假设的routing keys日志将会有两个单词: "<facility>.<severity>".

emit_log_topic.php文件代码:

```php
<?php
require_once dirname(dirname(__DIR__)) . '/vendor/autoload.php';

use PhpAmqpLib\Connection\AMQPStreamConnection;
use PhpAmqpLib\Message\AMQPMessage;

$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');
$channel = $connection->channel();

$channel->exchange_declare('topic_logs', 'topic', false, false, false);

$routing_key = isset($argv[1]) && !empty($argv[1]) ? $argv[1] : 'anonymous.info';
$data = implode(' ', array_slice($argv, 2));
if(empty($data)) $data = "Hello World!";

$msg = new AMQPMessage($data);

$channel->basic_publish($msg, 'topic_logs', $routing_key);

echo " [x] Sent ",$routing_key,':',$data," \n";

$channel->close();
$connection->close();
```

receive_logs_topic.php文件代码

```php
<?php
require_once dirname(dirname(__DIR__)) . '/vendor/autoload.php';


use PhpAmqpLib\Connection\AMQPStreamConnection;

$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');
$channel = $connection->channel();

$channel->exchange_declare('topic_logs', 'topic', false, false, false);

list($queue_name, ,) = $channel->queue_declare("", false, false, true, false);

$binding_keys = array_slice($argv, 1);
if( empty($binding_keys )) {
    file_put_contents('php://stderr', "Usage: $argv[0] [binding_key]\n");
    exit(1);
}

foreach($binding_keys as $binding_key) {
    $channel->queue_bind($queue_name, 'topic_logs', $binding_key);
}

echo ' [*] Waiting for logs. To exit press CTRL+C', "\n";

$callback = function($msg){
    echo ' [x] ',$msg->delivery_info['routing_key'], ':', $msg->body, "\n";
};

$channel->basic_consume($queue_name, '', false, true, false, false, $callback);

while(count($channel->callbacks)) {
    $channel->wait();
}

$channel->close();
$connection->close();
```

接收所有消息

```php
php receive_logs_topic.php "#"
```

接收"kern"消息

```php
php receive_logs_topic.php "kern.*"
```


接收"critical"消息

```php
php receive_logs_topic.php "*.critical"
```

创建多绑定
```php
php receive_logs_topic.php "kern.*" "*.critical"
```

创建routing key="kern.critical"类型绑定
```php
php emit_log_topic.php "kern.critical" "A critical kernel error"
```
